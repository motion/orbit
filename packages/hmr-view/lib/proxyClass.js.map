{"version":3,"sources":["../src/proxyClass.js"],"names":["createClassProxy","RESERVED_STATICS","isEqualDescriptor","a","b","key","getDisplayName","Component","displayName","name","allProxies","findProxy","pair","addProxy","proxy","push","proxyClass","InitialComponent","existingProxy","CurrentComponent","ProxyComponent","savedDescriptors","instantiate","factory","context","params","component","apply","err","instance","Object","keys","forEach","indexOf","Function","arguments","defineProperty","value","toString","prototypeProxy","prototype","isReactComponent","get","update","NextComponent","Error","__getCurrent","PreviousComponent","__proto__","getOwnPropertyNames","prevDescriptor","getOwnPropertyDescriptor","savedDescriptor","nextDescriptor","configurable","hasOwnProperty","proxyDescriptor","mountedInstances","constructor","getCurrent","writable","enumerable","createFallback"],"mappings":"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","file":"proxyClass.js","sourcesContent":["import { find } from 'lodash'\nimport createPrototypeProxy from './proxyProto'\nimport bindAutoBindMethods from './bindAutoBindMethods'\nimport deleteUnknownAutoBindMethods from './deleteUnknownAutoBindMethods'\nimport supportsProtoAssignment from './supportsProtoAssignment'\n\nconst RESERVED_STATICS = [\n  'length',\n  'displayName',\n  'name',\n  'arguments',\n  'caller',\n  'prototype',\n  'toString',\n]\n\nfunction isEqualDescriptor(a, b) {\n  if (!a && !b) {\n    return true\n  }\n  if (!a || !b) {\n    return false\n  }\n  for (let key in a) {\n    if (a[key] !== b[key]) {\n      return false\n    }\n  }\n  return true\n}\n\nfunction getDisplayName(Component) {\n  const displayName = Component.displayName || Component.name\n  return displayName && displayName !== 'ReactComponent'\n    ? displayName\n    : 'Unknown'\n}\n\nlet allProxies = []\nfunction findProxy(Component) {\n  const pair = find(allProxies, ([key]) => key === Component)\n  return pair ? pair[1] : null\n}\nfunction addProxy(Component, proxy) {\n  allProxies.push([Component, proxy])\n}\n\nfunction proxyClass(InitialComponent) {\n  // Prevent double wrapping.\n  // Given a proxy class, return the existing proxy managing it.\n  var existingProxy = findProxy(InitialComponent)\n  if (existingProxy) {\n    return existingProxy\n  }\n\n  let CurrentComponent\n  let ProxyComponent\n  let savedDescriptors = {}\n\n  function instantiate(factory, context, params) {\n    const component = factory()\n\n    try {\n      return component.apply(context, params)\n    } catch (err) {\n      const instance = new component(...params)\n      Object.keys(instance).forEach(key => {\n        if (RESERVED_STATICS.indexOf(key) > -1) {\n          return\n        }\n        context[key] = instance[key]\n      })\n    }\n  }\n\n  let displayName = getDisplayName(InitialComponent)\n  try {\n    // Create a proxy constructor with matching name\n    ProxyComponent = new Function(\n      'factory',\n      'instantiate',\n      `return function ${displayName}() {\n         return instantiate(factory, this, arguments);\n      }`\n    )(() => CurrentComponent, instantiate)\n  } catch (err) {\n    // Some environments may forbid dynamic evaluation\n    ProxyComponent = function() {\n      return instantiate(() => CurrentComponent, this, arguments)\n    }\n  }\n  try {\n    Object.defineProperty(ProxyComponent, 'name', {\n      value: displayName,\n    })\n  } catch (err) {}\n\n  // Proxy toString() to the current constructor\n  ProxyComponent.toString = function toString() {\n    return CurrentComponent.toString()\n  }\n\n  let prototypeProxy\n  if (\n    InitialComponent.prototype &&\n    InitialComponent.prototype.isReactComponent\n  ) {\n    // Point proxy constructor to the proxy prototype\n    prototypeProxy = createPrototypeProxy()\n    ProxyComponent.prototype = prototypeProxy.get()\n  }\n\n  function update(NextComponent) {\n    if (typeof NextComponent !== 'function') {\n      throw new Error('Expected a constructor.')\n    }\n    if (NextComponent === CurrentComponent) {\n      return\n    }\n\n    // Prevent proxy cycles\n    var existingProxy = findProxy(NextComponent)\n    if (existingProxy) {\n      return update(existingProxy.__getCurrent())\n    }\n\n    // Save the next constructor so we call it\n    const PreviousComponent = CurrentComponent\n    CurrentComponent = NextComponent\n\n    // Try to infer displayName\n    displayName = getDisplayName(NextComponent)\n    ProxyComponent.displayName = displayName\n    try {\n      Object.defineProperty(ProxyComponent, 'name', {\n        value: displayName,\n      })\n    } catch (err) {}\n\n    // Set up the same prototype for inherited statics\n    ProxyComponent.__proto__ = NextComponent.__proto__\n\n    // Copy over static methods and properties added at runtime\n    if (PreviousComponent) {\n      Object.getOwnPropertyNames(PreviousComponent).forEach(key => {\n        if (RESERVED_STATICS.indexOf(key) > -1) {\n          return\n        }\n\n        const prevDescriptor = Object.getOwnPropertyDescriptor(\n          PreviousComponent,\n          key\n        )\n        const savedDescriptor = savedDescriptors[key]\n\n        if (!isEqualDescriptor(prevDescriptor, savedDescriptor)) {\n          Object.defineProperty(NextComponent, key, prevDescriptor)\n        }\n      })\n    }\n\n    // Copy newly defined static methods and properties\n    Object.getOwnPropertyNames(NextComponent).forEach(key => {\n      if (RESERVED_STATICS.indexOf(key) > -1) {\n        return\n      }\n\n      const prevDescriptor =\n        PreviousComponent &&\n        Object.getOwnPropertyDescriptor(PreviousComponent, key)\n      const savedDescriptor = savedDescriptors[key]\n\n      // Skip redefined descriptors\n      if (\n        prevDescriptor &&\n        savedDescriptor &&\n        !isEqualDescriptor(savedDescriptor, prevDescriptor)\n      ) {\n        Object.defineProperty(NextComponent, key, prevDescriptor)\n        Object.defineProperty(ProxyComponent, key, prevDescriptor)\n        return\n      }\n\n      if (prevDescriptor && !savedDescriptor) {\n        Object.defineProperty(ProxyComponent, key, prevDescriptor)\n        return\n      }\n\n      const nextDescriptor = {\n        ...Object.getOwnPropertyDescriptor(NextComponent, key),\n        configurable: true,\n      }\n      savedDescriptors[key] = nextDescriptor\n      Object.defineProperty(ProxyComponent, key, nextDescriptor)\n    })\n\n    // Remove static methods and properties that are no longer defined\n    Object.getOwnPropertyNames(ProxyComponent).forEach(key => {\n      if (RESERVED_STATICS.indexOf(key) > -1) {\n        return\n      }\n      // Skip statics that exist on the next class\n      if (NextComponent.hasOwnProperty(key)) {\n        return\n      }\n      // Skip non-configurable statics\n      const proxyDescriptor = Object.getOwnPropertyDescriptor(\n        ProxyComponent,\n        key\n      )\n      if (proxyDescriptor && !proxyDescriptor.configurable) {\n        return\n      }\n\n      const prevDescriptor =\n        PreviousComponent &&\n        Object.getOwnPropertyDescriptor(PreviousComponent, key)\n      const savedDescriptor = savedDescriptors[key]\n\n      // Skip redefined descriptors\n      if (\n        prevDescriptor &&\n        savedDescriptor &&\n        !isEqualDescriptor(savedDescriptor, prevDescriptor)\n      ) {\n        return\n      }\n\n      delete ProxyComponent[key]\n    })\n\n    if (prototypeProxy) {\n      // Update the prototype proxy with new methods\n      const mountedInstances = prototypeProxy.update(NextComponent.prototype)\n\n      // Set up the constructor property so accessing the statics work\n      ProxyComponent.prototype.constructor = NextComponent\n\n      // We might have added new methods that need to be auto-bound\n      mountedInstances.forEach(bindAutoBindMethods)\n      mountedInstances.forEach(deleteUnknownAutoBindMethods)\n\n      return mountedInstances\n    }\n  }\n\n  function get() {\n    return ProxyComponent\n  }\n\n  function getCurrent() {\n    return CurrentComponent\n  }\n\n  update(InitialComponent)\n\n  const proxy = { get, update }\n  addProxy(ProxyComponent, proxy)\n\n  Object.defineProperty(proxy, '__getCurrent', {\n    configurable: false,\n    writable: false,\n    enumerable: false,\n    value: getCurrent,\n  })\n\n  return proxy\n}\n\nfunction createFallback(Component) {\n  let CurrentComponent = Component\n\n  return {\n    get() {\n      return CurrentComponent\n    },\n    update(NextComponent) {\n      CurrentComponent = NextComponent\n    },\n  }\n}\n\nexport default function createClassProxy(Component) {\n  return Component.__proto__ && supportsProtoAssignment()\n    ? proxyClass(Component)\n    : createFallback(Component)\n}\n"]}