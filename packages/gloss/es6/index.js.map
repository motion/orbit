{"version":3,"sources":["../src/index.js"],"names":["Helpers_","Theme","ThemeProvide","Helpers","hash","DEFAULT_OPTS","themeKey","idCounter","uid","Gloss","opts","themeSheets","JSS","decorator","optionalNameOrChild","optionalStyle","optionalPropStyles","tagName","styles","id","glossComponent","finalProps","props","Object","keys","key","createElement","glossUID","attachStyles","err","console","log","displayName","Child","error","children","prototype","css","glossElement","gloss","glossStylesheet","stylesheet","hasTheme","theme","themeSheet","createStyleSheet","attach","ViewCache","glossUpdateTheme","activeTheme","base","context","uiThemes","uiActiveThemeName","childTheme","oldKey","themeActiveRules","deleteRule","rules","name","style","selector","addRules","ogcomponentWillUpdate","componentWillUpdate","args","call","ogcomponentWillUnmount","componentWillUnmount","lastUpdatedStyles","ogrender","render","window","lastHotReload","Date","now","ogComponentWillMount","componentWillMount","childKey","force","addRule","stylesKey","getRule","niceStyle","options","helpers","baseStyles"],"mappings":"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","file":"index.js","sourcesContent":["// @flow\nimport fancyElement from './fancyElement'\nimport css from '@mcro/css'\nimport JSS from '~/stylesheet'\nimport * as Helpers_ from '@mcro/css'\n\n// exports\nimport ThemeProvide_ from './components/themeProvide'\nimport Theme_ from './components/theme'\nexport const Theme = Theme_\nexport const ThemeProvide = ThemeProvide_\nexport const Helpers = Helpers_\n\n// type exports\n// import { Transform, Color } from '@mcro/css'\n// export type Transform\n// export type Color\nexport type Options = {\n  dontTheme?: boolean,\n  themeKey: string | boolean,\n  baseStyles?: Object,\n  tagName?: boolean,\n  toColor?: Function,\n  isColor?: Function,\n}\n\nconst { hash } = Helpers\n\nconst DEFAULT_OPTS = {\n  themeKey: 'theme',\n}\n\nlet idCounter = 0\nfunction uid() {\n  return idCounter++\n}\n\nexport default class Gloss {\n  options: Options\n  css: (a: Object) => Object\n  baseStyles: ?Object\n  createElement: Function\n  Helpers: Object = Helpers\n  themeSheets = {}\n  // for debug\n  JSS = JSS\n\n  constructor(opts: Options = DEFAULT_OPTS) {\n    this.options = opts\n    this.css = css(opts)\n    this.helpers = this.css.helpers\n    this.stylesheet = JSS.createStyleSheet()\n    this.stylesheet.attach()\n    if (opts.baseStyles) {\n      this.baseStyles = true\n      this.attachStyles(null, opts.baseStyles)\n    }\n    this.createElement = fancyElement(this, this.stylesheet)\n    this.decorator.createElement = this.createElement\n  }\n\n  decorator = (\n    optionalNameOrChild: string | Function,\n    optionalStyle?: Object,\n    optionalPropStyles?: Object,\n  ) => {\n    if (typeof optionalNameOrChild === 'string') {\n      // shorthand -- $('tagName', {}) style component\n      const tagName = optionalNameOrChild\n      const styles = optionalStyle\n      const id = uid()\n      const glossComponent = props => {\n        let finalProps\n        // make propstyles work\n        if (props && optionalPropStyles) {\n          finalProps = {}\n          for (const key of Object.keys(props)) {\n            if (optionalPropStyles[key]) {\n              finalProps[`$${key}`] = props[key]\n            } else {\n              finalProps[key] = props[key]\n            }\n          }\n        } else {\n          finalProps = props\n        }\n        return this.createElement(tagName, { glossUID: id, ...finalProps })\n      }\n      try {\n        this.attachStyles(id, { [tagName]: styles, ...optionalPropStyles })\n      } catch (err) {\n        console.log('error attaching styles:', tagName, this, styles)\n      }\n      glossComponent.displayName = tagName\n      return glossComponent\n    }\n\n    const Child = optionalNameOrChild\n\n    if (!Child) {\n      console.error(\n        'invalid view given to gloss',\n        optionalNameOrChild,\n        optionalStyle,\n        optionalPropStyles,\n      )\n      return () => this.createElement('div', { children: 'Error Component' })\n    }\n\n    // @view decorated style component\n    if (Child.prototype) {\n      const { attachStyles, css } = this\n\n      Child.prototype.glossElement = this.createElement\n      Child.prototype.gloss = this\n      Child.prototype.glossStylesheet = this.stylesheet\n\n      const hasTheme = Child.theme && typeof Child.theme === 'function'\n      const themeSheet = JSS.createStyleSheet().attach()\n      const ViewCache = {}\n      const id = uid()\n      Child.glossUID = id\n      this.themeSheets[id] = themeSheet\n\n      if (hasTheme) {\n        Child.prototype.glossUpdateTheme = function(props) {\n          this.theme = this.theme || themeSheet\n          let activeTheme\n          if (typeof props.theme === 'object') {\n            activeTheme = { base: props.theme }\n          } else {\n            activeTheme =\n              this.context.uiThemes &&\n              this.context.uiThemes[\n                props.theme || this.context.uiActiveThemeName\n              ]\n          }\n          if (activeTheme) {\n            const childTheme = Child.theme(props, activeTheme, this)\n\n            // cache\n            const oldKey = this.themeKey\n            this.themeKey = `${id}${hash(childTheme)}`\n            if (ViewCache[this.themeKey]) {\n              ViewCache[this.themeKey]++\n              return\n            }\n            if (oldKey) {\n              ViewCache[this.themeKey]--\n              if (ViewCache[this.themeKey] === 0) {\n                for (const key of this.themeActiveRules) {\n                  this.theme.deleteRule(key)\n                }\n              }\n            }\n            ViewCache[this.themeKey] = 1\n\n            const rules = {}\n            for (const name of Object.keys(childTheme)) {\n              const style = css(childTheme[name])\n              const selector = `${name}--${this.themeKey}--theme`\n              rules[selector] = style\n              this.theme.deleteRule(selector)\n            }\n            this.themeActiveRules = Object.keys(rules)\n            this.theme.addRules(rules)\n          }\n        }\n\n        // updateTheme on willUpdate\n        const ogcomponentWillUpdate = Child.prototype.componentWillUpdate\n        Child.prototype.componentWillUpdate = function(...args) {\n          this.glossUpdateTheme(args[0])\n          if (ogcomponentWillUpdate) {\n            return ogcomponentWillUpdate.call(this, ...args)\n          }\n        }\n\n        const ogcomponentWillUnmount = Child.prototype.componentWillUnmount\n        Child.prototype.componentWillUnmount = function(...args) {\n          // remove cache\n          ViewCache[this.themeKey]--\n          if (ViewCache[this.themeKey] === 0 && this.themeActiveRules) {\n            for (const key of this.themeActiveRules) {\n              this.theme.deleteRule(key)\n            }\n          }\n          if (ogcomponentWillUnmount) {\n            return ogcomponentWillUnmount.call(this, ...args)\n          }\n        }\n      }\n\n      let lastUpdatedStyles = null\n      const ogrender = Child.prototype.render\n      Child.prototype.render = function(...args) {\n        // ONLY IN DEV -- ALWAYS UPDATE STYLESHEET SO HMR STYLE CHANGES WORK\n        if (\n          !lastUpdatedStyles ||\n          (typeof window !== 'undefined' &&\n            window.lastHotReload &&\n            lastUpdatedStyles > window.lastHotReload)\n        ) {\n          attachStyles(Child.glossUID, Child.style, true)\n          lastUpdatedStyles = Date.now()\n        }\n        if (ogrender) {\n          return ogrender.call(this, ...args)\n        }\n      }\n\n      // on first mount, attach styles\n      const ogComponentWillMount = Child.prototype.componentWillMount\n      Child.prototype.componentWillMount = function(...args) {\n        if (hasTheme) {\n          this.glossUpdateTheme(this.props)\n        }\n        if (ogComponentWillMount) {\n          return ogComponentWillMount.call(this, ...args)\n        }\n      }\n    }\n  }\n\n  // runs niceStyleSheet on non-function styles\n  attachStyles = (\n    childKey: ?string,\n    styles: ?{ [a: string]: Object },\n    force: boolean = false,\n  ): void => {\n    if (!styles) {\n      return null\n    }\n    for (const key of Object.keys(styles)) {\n      const style = styles[key]\n      // @keyframes\n      if (key[0] === '@') {\n        console.log('adding animation')\n        this.stylesheet.addRule(key, style)\n        continue\n      }\n      const stylesKey = childKey ? `${key}--${childKey}` : key\n      if (typeof style === 'function') {\n        this.stylesheet[stylesKey] = style\n        continue\n      }\n      if (force) {\n        this.stylesheet.deleteRule(stylesKey)\n      }\n      if (!this.stylesheet.getRule(stylesKey)) {\n        const niceStyle = this.css(style)\n        this.stylesheet.addRule(stylesKey, niceStyle)\n      }\n    }\n  }\n}\n"]}