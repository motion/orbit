#!/bin/bash

. $(dirname $0)/__/common
cd $ROOT

# dont allow errors
set -e

file-exists ".env"
source .env

xcode-select --install 2> /dev/null || true
# this on in sync before running brew checks
ensure-dep "brew" -- /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
ensure-dep "npm" -- brew install node &
ensure-dep "realpath" -- brew install coreutils &
ensure-dep "yarn" -- npm i -g yarn &
ensure-dep "python3" -- pyenv install 3.6.6 || brew install python3 &
# ensure-dep "carthage" -- brew install carthage &
wait
ensure-dep "tsc" -- npm i -g typescript

# this was to build the modules used to build...
# but we publish them not enough they should work, i think
# internal tools
# if [ ! -f "./packages/gloss/_/gloss.js" ]; then
#   bin/__/build-builder-modules
# fi
# # link second
# if [ ! -L "./node_modules/@o/gloss" ]; then
#   bin/__/link-root-modules
# fi

echo "installing root"
yarn install
echo "installing packages"
npx lerna bootstrap --loglevel=warn
# build everything
if [ ! -d "./app/orbit-desktop/_" ]; then
  bin/build
fi

printf "\n\n"
printf "  ðŸŽ‰ðŸŽ‰ðŸŽ‰ bootstrapped! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
printf "\n\n"
printf "1) be sure you are running:"
printf "\n\n"
printf "    build --watch"
printf "\n\n"
printf "2) wait a sec, then run:"
printf "\n\n"
printf "    run orbit\n"
printf "\n\n"
