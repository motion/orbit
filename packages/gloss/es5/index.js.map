{"version":3,"sources":["../src/index.js"],"names":["glossFactory","Helpers_","Theme","ThemeProvide","Helpers","hash","DEFAULT_OPTS","themeKey","idCounter","uid","Gloss","opts","themeSheets","decorator","Child","prototype","attachStyles","css","glossElement","createElement","gloss","glossStylesheet","stylesheet","hasTheme","theme","themeSheet","createStyleSheet","attach","ViewCache","id","glossUID","glossUpdateTheme","props","activeTheme","base","context","uiThemes","uiActiveThemeName","childTheme","oldKey","themeActiveRules","key","deleteRule","rules","Object","keys","name","style","selector","addRules","ogcomponentWillUpdate","componentWillUpdate","args","call","ogcomponentWillUnmount","componentWillUnmount","lastUpdatedStyles","ogrender","render","window","lastHotReload","Date","now","ogComponentWillMount","componentWillMount","childKey","styles","force","stylesKey","getRule","niceStyle","addRule","options","helpers","baseStyles"],"mappings":";;;;;;;;;kBAqMwBA,Y;;AApMxB;;;;AACA;;IAEYC,Q;;AADZ;;;;AAIA;;;;AACA;;;;;;;;;;AAFA;;;AAGO,IAAMC,uCAAN;AACA,IAAMC,4DAAN;AACA,IAAMC,4BAAUH,QAAhB;;AAEP;IAWQI,I,GAASD,O,CAATC,I;;;AAER,IAAMC,eAAe;AACnBC,YAAU;AADS,CAArB;;AAIA,IAAIC,YAAY,CAAhB;AACA,SAASC,GAAT,GAAe;AACb,SAAOD,WAAP;AACD;;IAEYE,K,WAAAA,K,GAQX,iBAA0C;AAAA;;AAAA,MAA9BC,IAA8B,uEAAdL,YAAc;;AAAA;;AAAA,OAH1CF,OAG0C,GAHxBA,OAGwB;AAAA,OAF1CQ,WAE0C,GAF5B,EAE4B;;AAAA,OAc1CC,SAd0C,GAc9B,UAACC,KAAD,EAAqB;AAC/B,QAAIA,MAAMC,SAAV,EAAqB;AAAA,UACXC,YADW,SACXA,YADW;AAAA,UACGC,IADH,SACGA,GADH;;;AAGnBH,YAAMC,SAAN,CAAgBG,YAAhB,GAA+B,MAAKC,aAApC;AACAL,YAAMC,SAAN,CAAgBK,KAAhB;AACAN,YAAMC,SAAN,CAAgBM,eAAhB,GAAkC,MAAKC,UAAvC;;AAEA,UAAMC,WAAWT,MAAMU,KAAN,IAAe,OAAOV,MAAMU,KAAb,KAAuB,UAAvD;AACA,UAAMC,aAAa,qBAAIC,gBAAJ,GAAuBC,MAAvB,EAAnB;AACA,UAAMC,YAAY,EAAlB;AACA,UAAMC,KAAKpB,KAAX;AACAK,YAAMgB,QAAN,GAAiBD,EAAjB;AACA,YAAKjB,WAAL,CAAiBiB,EAAjB,IAAuBJ,UAAvB;;AAEA,UAAIF,QAAJ,EAAc;AACZT,cAAMC,SAAN,CAAgBgB,gBAAhB,GAAmC,UAASC,KAAT,EAAgB;AACjD,eAAKR,KAAL,GAAa,KAAKA,KAAL,IAAcC,UAA3B;AACA,cAAIQ,oBAAJ;AACA,cAAI,QAAOD,MAAMR,KAAb,MAAuB,QAA3B,EAAqC;AACnCS,0BAAc,EAAEC,MAAMF,MAAMR,KAAd,EAAd;AACD,WAFD,MAEO;AACLS,0BACE,KAAKE,OAAL,CAAaC,QAAb,IACA,KAAKD,OAAL,CAAaC,QAAb,CACEJ,MAAMR,KAAN,IAAe,KAAKW,OAAL,CAAaE,iBAD9B,CAFF;AAKD;AACD,cAAIJ,WAAJ,EAAiB;AACf,gBAAMK,aAAaxB,MAAMU,KAAN,CAAYQ,KAAZ,EAAmBC,WAAnB,EAAgC,IAAhC,CAAnB;;AAEA;AACA,gBAAMM,SAAS,KAAKhC,QAApB;AACA,iBAAKA,QAAL,QAAmBsB,EAAnB,GAAwBxB,KAAKiC,UAAL,CAAxB;AACA,gBAAIV,UAAU,KAAKrB,QAAf,CAAJ,EAA8B;AAC5BqB,wBAAU,KAAKrB,QAAf;AACA;AACD;AACD,gBAAIgC,MAAJ,EAAY;AACVX,wBAAU,KAAKrB,QAAf;AACA,kBAAIqB,UAAU,KAAKrB,QAAf,MAA6B,CAAjC,EAAoC;AAAA;AAAA;AAAA;;AAAA;AAClC,uCAAkB,KAAKiC,gBAAvB,8HAAyC;AAAA,wBAA9BC,GAA8B;;AACvC,yBAAKjB,KAAL,CAAWkB,UAAX,CAAsBD,GAAtB;AACD;AAHiC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAInC;AACF;AACDb,sBAAU,KAAKrB,QAAf,IAA2B,CAA3B;;AAEA,gBAAMoC,QAAQ,EAAd;AApBe;AAAA;AAAA;;AAAA;AAqBf,oCAAmBC,OAAOC,IAAP,CAAYP,UAAZ,CAAnB,mIAA4C;AAAA,oBAAjCQ,IAAiC;;AAC1C,oBAAMC,QAAQ9B,KAAIqB,WAAWQ,IAAX,CAAJ,CAAd;AACA,oBAAME,WAAcF,IAAd,UAAuB,KAAKvC,QAA5B,YAAN;AACAoC,sBAAMK,QAAN,IAAkBD,KAAlB;AACA,qBAAKvB,KAAL,CAAWkB,UAAX,CAAsBM,QAAtB;AACD;AA1Bc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AA2Bf,iBAAKR,gBAAL,GAAwBI,OAAOC,IAAP,CAAYF,KAAZ,CAAxB;AACA,iBAAKnB,KAAL,CAAWyB,QAAX,CAAoBN,KAApB;AACD;AACF,SA1CD;;AA4CA;AACA,YAAMO,wBAAwBpC,MAAMC,SAAN,CAAgBoC,mBAA9C;AACArC,cAAMC,SAAN,CAAgBoC,mBAAhB,GAAsC,YAAkB;AAAA,4CAANC,IAAM;AAANA,gBAAM;AAAA;;AACtD,eAAKrB,gBAAL,CAAsBqB,KAAK,CAAL,CAAtB;AACA,cAAIF,qBAAJ,EAA2B;AACzB,mBAAOA,sBAAsBG,IAAtB,+BAA2B,IAA3B,SAAoCD,IAApC,EAAP;AACD;AACF,SALD;;AAOA,YAAME,yBAAyBxC,MAAMC,SAAN,CAAgBwC,oBAA/C;AACAzC,cAAMC,SAAN,CAAgBwC,oBAAhB,GAAuC,YAAkB;AACvD;AACA3B,oBAAU,KAAKrB,QAAf;AACA,cAAIqB,UAAU,KAAKrB,QAAf,MAA6B,CAA7B,IAAkC,KAAKiC,gBAA3C,EAA6D;AAAA;AAAA;AAAA;;AAAA;AAC3D,oCAAkB,KAAKA,gBAAvB,mIAAyC;AAAA,oBAA9BC,GAA8B;;AACvC,qBAAKjB,KAAL,CAAWkB,UAAX,CAAsBD,GAAtB;AACD;AAH0D;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAI5D;AACD,cAAIa,sBAAJ,EAA4B;AAAA,+CARqBF,IAQrB;AARqBA,kBAQrB;AAAA;;AAC1B,mBAAOE,uBAAuBD,IAAvB,gCAA4B,IAA5B,SAAqCD,IAArC,EAAP;AACD;AACF,SAXD;AAYD;;AAED,UAAII,oBAAoB,IAAxB;AACA,UAAMC,WAAW3C,MAAMC,SAAN,CAAgB2C,MAAjC;AACA5C,YAAMC,SAAN,CAAgB2C,MAAhB,GAAyB,YAAkB;AACzC;AACA,YACE,CAACF,iBAAD,IACCG,OAAOC,aAAP,IAAwBJ,oBAAoBG,OAAOC,aAFtD,EAGE;AACA5C,uBAAaF,MAAMgB,QAAnB,EAA6BhB,MAAMiC,KAAnC,EAA0C,IAA1C;AACAS,8BAAoBK,KAAKC,GAAL,EAApB;AACD;AACD,YAAIL,QAAJ,EAAc;AAAA,6CATqBL,IASrB;AATqBA,gBASrB;AAAA;;AACZ,iBAAOK,SAASJ,IAAT,kBAAc,IAAd,SAAuBD,IAAvB,EAAP;AACD;AACF,OAZD;;AAcA;AACA,UAAMW,uBAAuBjD,MAAMC,SAAN,CAAgBiD,kBAA7C;AACAlD,YAAMC,SAAN,CAAgBiD,kBAAhB,GAAqC,YAAkB;AACrD,YAAIzC,QAAJ,EAAc;AACZ,eAAKQ,gBAAL,CAAsB,KAAKC,KAA3B;AACD;AACD,YAAI+B,oBAAJ,EAA0B;AAAA,6CAJqBX,IAIrB;AAJqBA,gBAIrB;AAAA;;AACxB,iBAAOW,qBAAqBV,IAArB,8BAA0B,IAA1B,SAAmCD,IAAnC,EAAP;AACD;AACF,OAPD;AAQD;AACF,GA7HyC;;AAAA,OAgI1CpC,YAhI0C,GAgI3B,UACbiD,QADa,EAEbC,MAFa,EAIJ;AAAA,QADTC,KACS,uEADQ,KACR;;AACT,QAAI,CAACD,MAAL,EAAa;AACX,aAAO,IAAP;AACD;AAHQ;AAAA;AAAA;;AAAA;AAIT,4BAAkBtB,OAAOC,IAAP,CAAYqB,MAAZ,CAAlB,mIAAuC;AAAA,YAA5BzB,GAA4B;;AACrC,YAAMM,QAAQmB,OAAOzB,GAAP,CAAd;AACA,YAAM2B,YAAYH,WAAcxB,GAAd,UAAsBwB,QAAtB,GAAmCxB,GAArD;AACA,YAAI,OAAOM,KAAP,KAAiB,UAArB,EAAiC;AAC/B,gBAAKzB,UAAL,CAAgB8C,SAAhB,IAA6BrB,KAA7B;AACA;AACD;AACD,YAAIoB,KAAJ,EAAW;AACT,gBAAK7C,UAAL,CAAgBoB,UAAhB,CAA2B0B,SAA3B;AACD;AACD,YAAI,CAAC,MAAK9C,UAAL,CAAgB+C,OAAhB,CAAwBD,SAAxB,CAAL,EAAyC;AACvC,cAAME,YAAY,MAAKrD,GAAL,CAAS8B,KAAT,CAAlB;AACA,gBAAKzB,UAAL,CAAgBiD,OAAhB,CAAwBH,SAAxB,EAAmCE,SAAnC;AACD;AACF;AAlBQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAmBV,GAvJyC;;AACxC,OAAKE,OAAL,GAAe7D,IAAf;AACA,OAAKM,GAAL,GAAW,IAzCHhB,QAyCG,UAAIU,IAAJ,CAAX;AACA,OAAK8D,OAAL,GAAe,KAAKxD,GAAL,CAASwD,OAAxB;AACA,OAAKnD,UAAL,GAAkB,qBAAII,gBAAJ,EAAlB;AACA,OAAKJ,UAAL,CAAgBK,MAAhB;AACA,MAAIhB,KAAK+D,UAAT,EAAqB;AACnB,SAAKA,UAAL,GAAkB,IAAlB;AACA,SAAK1D,YAAL,CAAkB,IAAlB,EAAwBL,KAAK+D,UAA7B;AACD;AACD,OAAKvD,aAAL,GAAqB,4BAAa,IAAb,EAAmB,KAAKG,UAAxB,CAArB;AACA,OAAKT,SAAL,CAAeM,aAAf,GAA+B,KAAKA,aAApC;AACD;;AAmHD;;;AA2Ba,SAASnB,YAAT,CAAsBwE,OAAtB,EAA+C;AAC5D,SAAO,IAAI9D,KAAJ,CAAU8D,OAAV,CAAP;AACD","file":"index.js","sourcesContent":["// @flow\nimport fancyElement from './fancyElement'\nimport css from '@mcro/css'\nimport JSS from './stylesheet'\nimport * as Helpers_ from '@mcro/css'\n\n// exports\nimport ThemeProvide_ from './components/themeProvide'\nimport Theme_ from './components/theme'\nexport const Theme = Theme_\nexport const ThemeProvide = ThemeProvide_\nexport const Helpers = Helpers_\n\n// type exports\nexport type { Transform, Color } from '@mcro/css'\nexport type Options = {\n  dontTheme?: boolean,\n  themeKey: string | boolean,\n  baseStyles?: Object,\n  tagName?: boolean,\n  toColor?: Function,\n  isColor?: Function,\n}\n\nconst { hash } = Helpers\n\nconst DEFAULT_OPTS = {\n  themeKey: 'theme',\n}\n\nlet idCounter = 0\nfunction uid() {\n  return idCounter++\n}\n\nexport class Gloss {\n  options: Options\n  css: (a: Object) => Object\n  baseStyles: ?Object\n  createElement: Function\n  Helpers: Object = Helpers\n  themeSheets = {}\n\n  constructor(opts: Options = DEFAULT_OPTS) {\n    this.options = opts\n    this.css = css(opts)\n    this.helpers = this.css.helpers\n    this.stylesheet = JSS.createStyleSheet()\n    this.stylesheet.attach()\n    if (opts.baseStyles) {\n      this.baseStyles = true\n      this.attachStyles(null, opts.baseStyles)\n    }\n    this.createElement = fancyElement(this, this.stylesheet)\n    this.decorator.createElement = this.createElement\n  }\n\n  decorator = (Child: Function) => {\n    if (Child.prototype) {\n      const { attachStyles, css } = this\n\n      Child.prototype.glossElement = this.createElement\n      Child.prototype.gloss = this\n      Child.prototype.glossStylesheet = this.stylesheet\n\n      const hasTheme = Child.theme && typeof Child.theme === 'function'\n      const themeSheet = JSS.createStyleSheet().attach()\n      const ViewCache = {}\n      const id = uid()\n      Child.glossUID = id\n      this.themeSheets[id] = themeSheet\n\n      if (hasTheme) {\n        Child.prototype.glossUpdateTheme = function(props) {\n          this.theme = this.theme || themeSheet\n          let activeTheme\n          if (typeof props.theme === 'object') {\n            activeTheme = { base: props.theme }\n          } else {\n            activeTheme =\n              this.context.uiThemes &&\n              this.context.uiThemes[\n                props.theme || this.context.uiActiveThemeName\n              ]\n          }\n          if (activeTheme) {\n            const childTheme = Child.theme(props, activeTheme, this)\n\n            // cache\n            const oldKey = this.themeKey\n            this.themeKey = `${id}${hash(childTheme)}`\n            if (ViewCache[this.themeKey]) {\n              ViewCache[this.themeKey]++\n              return\n            }\n            if (oldKey) {\n              ViewCache[this.themeKey]--\n              if (ViewCache[this.themeKey] === 0) {\n                for (const key of this.themeActiveRules) {\n                  this.theme.deleteRule(key)\n                }\n              }\n            }\n            ViewCache[this.themeKey] = 1\n\n            const rules = {}\n            for (const name of Object.keys(childTheme)) {\n              const style = css(childTheme[name])\n              const selector = `${name}--${this.themeKey}--theme`\n              rules[selector] = style\n              this.theme.deleteRule(selector)\n            }\n            this.themeActiveRules = Object.keys(rules)\n            this.theme.addRules(rules)\n          }\n        }\n\n        // updateTheme on willUpdate\n        const ogcomponentWillUpdate = Child.prototype.componentWillUpdate\n        Child.prototype.componentWillUpdate = function(...args) {\n          this.glossUpdateTheme(args[0])\n          if (ogcomponentWillUpdate) {\n            return ogcomponentWillUpdate.call(this, ...args)\n          }\n        }\n\n        const ogcomponentWillUnmount = Child.prototype.componentWillUnmount\n        Child.prototype.componentWillUnmount = function(...args) {\n          // remove cache\n          ViewCache[this.themeKey]--\n          if (ViewCache[this.themeKey] === 0 && this.themeActiveRules) {\n            for (const key of this.themeActiveRules) {\n              this.theme.deleteRule(key)\n            }\n          }\n          if (ogcomponentWillUnmount) {\n            return ogcomponentWillUnmount.call(this, ...args)\n          }\n        }\n      }\n\n      let lastUpdatedStyles = null\n      const ogrender = Child.prototype.render\n      Child.prototype.render = function(...args) {\n        // ONLY IN DEV -- ALWAYS UPDATE STYLESHEET SO HMR STYLE CHANGES WORK\n        if (\n          !lastUpdatedStyles ||\n          (window.lastHotReload && lastUpdatedStyles > window.lastHotReload)\n        ) {\n          attachStyles(Child.glossUID, Child.style, true)\n          lastUpdatedStyles = Date.now()\n        }\n        if (ogrender) {\n          return ogrender.call(this, ...args)\n        }\n      }\n\n      // on first mount, attach styles\n      const ogComponentWillMount = Child.prototype.componentWillMount\n      Child.prototype.componentWillMount = function(...args) {\n        if (hasTheme) {\n          this.glossUpdateTheme(this.props)\n        }\n        if (ogComponentWillMount) {\n          return ogComponentWillMount.call(this, ...args)\n        }\n      }\n    }\n  }\n\n  // runs niceStyleSheet on non-function styles\n  attachStyles = (\n    childKey: ?string,\n    styles: ?{ [a: string]: Object },\n    force: boolean = false\n  ): void => {\n    if (!styles) {\n      return null\n    }\n    for (const key of Object.keys(styles)) {\n      const style = styles[key]\n      const stylesKey = childKey ? `${key}--${childKey}` : key\n      if (typeof style === 'function') {\n        this.stylesheet[stylesKey] = style\n        continue\n      }\n      if (force) {\n        this.stylesheet.deleteRule(stylesKey)\n      }\n      if (!this.stylesheet.getRule(stylesKey)) {\n        const niceStyle = this.css(style)\n        this.stylesheet.addRule(stylesKey, niceStyle)\n      }\n    }\n  }\n}\n\nexport default function glossFactory(options: Options): Gloss {\n  return new Gloss(options)\n}\n"]}