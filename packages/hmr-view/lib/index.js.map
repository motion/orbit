{"version":3,"sources":["../src/index.js"],"names":["proxyReactComponents","viewProxies","reloaded","reloadedInstances","filename","components","imports","locals","React","module","hot","accept","Error","forceUpdater","hotReload","instance","push","wrapWithProxy","ReactClass","uid","isInFunction","displayName","path","console","log","instances","update","setTimeout","forEach","get","setInterval","length","join"],"mappings":";;;;;;;;kBAQwBA,oB;;AARxB;;;;AACA;;;;AACA;;;;AAEA,IAAIC,cAAc,EAAlB;AACA,IAAIC,WAAW,EAAf;AACA,IAAIC,oBAAoB,EAAxB;;AAEe,SAASH,oBAAT,OAKZ;AAAA,MAJDI,QAIC,QAJDA,QAIC;AAAA,MAHDC,UAGC,QAHDA,UAGC;AAAA,MAFDC,OAEC,QAFDA,OAEC;AAAA,MADDC,MACC,QADDA,MACC;;AAAA,gCACeD,OADf;AAAA,MACME,KADN;;AAAA,+BAEgBD,MAFhB;AAAA,MAEME,MAFN;;AAAA,gCAGiBF,MAHjB;AAAA,MAGQG,GAHR,eAGQA,GAHR;;AAKD,MAAI,CAACA,GAAD,IAAQ,OAAOA,IAAIC,MAAX,KAAsB,UAAlC,EAA8C;AAC5C,UAAM,IAAIC,KAAJ,CACJ,8HADI,CAAN;AAGD;;AAED,MAAMC,eAAe,gCAAeL,SAAS,iBAAOA,KAA/B,CAArB;;AAEA,MAAMM,YAAY,SAAZA,SAAY,WAAY;AAC5BD,iBAAaE,QAAb;AACAZ,sBAAkBa,IAAlB,CAAuB,CAAvB;AACD,GAHD;;AAKA,SAAO,SAASC,aAAT,CAAuBC,UAAvB,EAAmCC,GAAnC,EAAwC;AAAA,0BACDd,WAAWc,GAAX,CADC;AAAA,QACrCC,YADqC,mBACrCA,YADqC;AAAA,gDACvBC,WADuB;AAAA,QACvBA,WADuB,yCACTF,GADS;;AAE7C,QAAMG,OAAOlB,WAAW,GAAX,GAAiBe,GAA9B;;AAEA,QAAIC,YAAJ,EAAkB;AAChB,aAAOF,UAAP;AACD;;AAEDT,WAAOC,GAAP,CAAWC,MAAX,CAAkB,YAAM;AACtBY,cAAQC,GAAR,CAAY,UAAZ,EAAwBF,IAAxB;AACD,KAFD,EAR6C,CAU1C;;AAEH;AACA,QAAIrB,YAAYqB,IAAZ,CAAJ,EAAuB;AACrBpB,eAASc,IAAT,CAAcK,WAAd;AACA,UAAMI,YAAYxB,YAAYqB,IAAZ,EAAkBI,MAAlB,CAAyBR,UAAzB,CAAlB;AACAS,iBAAW;AAAA,eAAMF,UAAUG,OAAV,CAAkBd,SAAlB,CAAN;AAAA,OAAX;AACD,KAJD,MAIO;AACLb,kBAAYqB,IAAZ,IAAoB,0BAAYJ,UAAZ,CAApB;AACD;;AAED,WAAOjB,YAAYqB,IAAZ,EAAkBO,GAAlB,EAAP;AACD,GAtBD;AAuBD;;AAEDC,YAAY,YAAM;AAChB,MAAI5B,SAAS6B,MAAb,EAAqB;AACnBR,YAAQC,GAAR,CACG,gBAAetB,SAAS8B,IAAT,CACd,IADc,CAEd,KAAI7B,kBAAkB4B,MAAO,YAHjC;AAKA7B,eAAW,EAAX;AACAC,wBAAoB,EAApB;AACD;AACF,CAVD,EAUG,IAVH","file":"index.js","sourcesContent":["import window from 'global/window'\nimport createProxy from './proxyClass'\nimport { getForceUpdate } from 'react-proxy'\n\nlet viewProxies = {}\nlet reloaded = []\nlet reloadedInstances = []\n\nexport default function proxyReactComponents({\n  filename,\n  components,\n  imports,\n  locals,\n}) {\n  const [React] = imports\n  const [module] = locals\n  const [{ hot }] = locals\n\n  if (!hot || typeof hot.accept !== 'function') {\n    throw new Error(\n      'locals[0] does not appear to be a `module` object with Hot Module replacement API enabled. You should disable @mcro/view-hmr'\n    )\n  }\n\n  const forceUpdater = getForceUpdate(React || window.React)\n\n  const hotReload = instance => {\n    forceUpdater(instance)\n    reloadedInstances.push(1)\n  }\n\n  return function wrapWithProxy(ReactClass, uid) {\n    const { isInFunction, displayName = uid } = components[uid]\n    const path = filename + '$' + uid\n\n    if (isInFunction) {\n      return ReactClass\n    }\n\n    module.hot.accept(() => {\n      console.log('accepted', path)\n    }) // to make it a fast hmr\n\n    // if existing proxy\n    if (viewProxies[path]) {\n      reloaded.push(displayName)\n      const instances = viewProxies[path].update(ReactClass)\n      setTimeout(() => instances.forEach(hotReload))\n    } else {\n      viewProxies[path] = createProxy(ReactClass)\n    }\n\n    return viewProxies[path].get()\n  }\n}\n\nsetInterval(() => {\n  if (reloaded.length) {\n    console.log(\n      `[HMR] views: ${reloaded.join(\n        ', '\n      )}, ${reloadedInstances.length} instances`\n    )\n    reloaded = []\n    reloadedInstances = []\n  }\n}, 1000)\n"]}