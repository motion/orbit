#!/bin/bash

. $(dirname $0)/__common
cd $ROOT

# ensure .env
# ensure docker
# ensure kubernetes
# ensure minikube

# for template parsing
pip install envtpl

# note to add insecure registry localhost:5000 to mac app

# kubernetes templates
brew install ktmpl

minikube config set WantReportErrorPrompt false
minikube config set vm-driver=xhyve

minikube addons enable ingress

# adds secrets, needs .env
kubectl create secret docker-registry $DOCKER_SECRET \
    --docker-server=$DOCKER_REGISTRY_SERVER \
    --docker-username=$DOCKER_USER \
    --docker-password=$DOCKER_PASSWORD \
    --docker-email=$DOCKER_EMAIL

# ensure xhyve
# ensure npm
# npm bootstrap

# /etc/hosts
echo "$(minikube ip) couch.staging.dev api.staging.dev staging.dev" | sudo tee -a /etc/hosts
echo "127.0.0.1 couch.jot.dev api.jot.dev jot.dev"

# run minikube

echo " welcome!"
echo " to start the app:"
echo "   $ minikube up"
echo "   $ dev start"
echo "   $ dev serve"
