#!/bin/bash

. $(dirname $0)/__/common
cd $ROOT

ACTION=$1
ARG1=$2

trap killgroup SIGINT
killgroup() {
  kill 0
}

function run-api() {
  cd $ROOT/apps/api
  if [ "$ARG1" = "--prod" ]; then
    # this is really test-prod
    npm run start-local-prod
  else
    npm run start-dev
  fi
}

function run-web() {
  # bugfix for bad bundles coming from uncompoled exports
  rm -rf packages/automagical/node_modules/mobx-utils/lib 2> /dev/null
  cd $ROOT/apps/web
  if [ "$ARG1" = "--clean" ]; then
    motion watch --debug --disable-cache
  elif [ "$ARG1" = "--prod" ]; then
    npm run start-prod
  elif [ "$ARG1" = "--webpack" ]; then
    node scripts/run.js
  else
    motion watch --debug
  fi
}

function run-site() {
  cd apps/site
  npm start
}

if [ "$ACTION" = "backend" ]; then
  echo "Open about:inspect in Chrome to debug Node"
  compose up ${@:2}
elif [ "$ACTION" = "electron" ] || [ "$ACTION" = "app" ]; then
  if [ "$ARG1" = "--prod" ]; then
    cd apps/electron
    npm run start-prod
  else
    cd apps/electron
    npm run watch &
    sleep 3
    npm start &
    wait
  fi
elif [ "$ACTION" =  "site" ]; then
  run-site ${@:2} &
  wait
elif [ "$ACTION" =  "api" ]; then
  run-api ${@:2}
elif [ "$ACTION" =  "web" ]; then
  if [ ! -d "$ROOT/packages/ui/lib" ]; then
    echo "Make sure to run 'build --watch' before running web"
    exit 0
  fi
  run-web ${@:2} &
  run-api ${@:2} &
  wait
else
  npm run $1 ${@:2}
fi
