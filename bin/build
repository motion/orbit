#!/bin/bash

. $(dirname $0)/__/common

# TODO move this into each package and just have this npm run build in each

if [ "$1" = "" ]; then
  npx oao all "yarn run build" --parallel
  exit 0
fi
if [ "$1" = "--watch" ]; then
  npx oao all "yarn run watch" --parallel --no-parallel-logs
  exit 0
fi

function build-prod() {
  BABEL_ENV=production babel src --out-dir dist -s true ${@:1}
}
function build-dev() {
  babel src --out-dir lib -s true ${@:1}
}
function build-es6() {
  BABEL_ENV=es6 babel src --out-dir es6 -s true ${@:1}
}

MODES="$1"
FLAGS=""
if [ "$2" = "--watch" ]; then
  FLAGS="--watch --skip-initial-build"
fi

for i in ${MODES//,/$IFS}; do
  if [ "$i" = "prod" ]; then
    build-prod $FLAGS &
  fi
  if [ "$i" = "dev" ]; then
    build-dev $FLAGS &
  fi
  if [ "$i" = "es6" ]; then
    build-es6 $FLAGS &
  fi
done

wait

# function build-dev() {
#   npx lerna exec --parallel \
#     --ignore @mcro/app \
#     --ignore @mcro/deliverx \
#     --ignore @mcro/site \
#     --ignore @mcro/oracle \
#     --ignore @mcro/desktop \
#     --ignore @mcro/builder \
#     --ignore @mcro/hmr \
#     --ignore @mcro/hmr-view \
#     --ignore @mcro/babel-preset-motion \
#       -- \
#       babel src --out-dir lib -s true ${@:1}
# }

# function build-es6() {
#   npx lerna exec --parallel \
#     --ignore @mcro/app \
#     --ignore @mcro/deliverx \
#     --ignore @mcro/electron-build \
#     --ignore @mcro/electron \
#     --ignore @mcro/crawler \
#     --ignore @mcro/search \
#     --ignore @mcro/constants \
#     --ignore @mcro/screendump \
#     --ignore @mcro/site \
#     --ignore @mcro/babel-preset-motion \
#     --ignore @mcro/ui \
#     --ignore @mcro/router \
#     --ignore @mcro/automagical \
#     --ignore @mcro/r2 \
#     --ignore @mcro/css \
#     --ignore @mcro/reactron \
#     --ignore @mcro/react-tunnel \
#       -- \
#         BABEL_ENV=es6 babel src --out-dir es6 -s true ${@:1}
# }

# function build-prod() {
#   npx lerna exec --parallel \
#     --ignore @mcro/app \
#     --ignore @mcro/deliverx \
#     --ignore @mcro/site \
#     --ignore @mcro/desktop \
#     --ignore @mcro/crawler \
#     --ignore @mcro/constants \
#     --ignore @mcro/search \
#     --ignore @mcro/electron \
#     --ignore @mcro/electron-build \
#     --ignore @mcro/builder \
#     --ignore @mcro/hmr \
#     --ignore @mcro/hmr-view \
#     --ignore @mcro/babel-preset-motion \
#       -- \
#         BABEL_ENV=production babel src --out-dir dist -s true ${@:1}
# }
