#!/bin/bash

. $(dirname $0)/__/common

if [ "$(realpath .)" = "$ROOT" ]; then
  echo "building.... $(pwd)"
  if [ "$1" = "--watch" ]; then

    # WATCH

    ARGS=${@:2}
    (bin/in ui npm run watch) &
    (cd app && ../node_modules/.bin/tsc --build --watch --preserveWatchOutput $ARGS) &
    sleep 3
    (bin/in kit npm run watch) &
    (bin/in kit-internal npm run watch) &
    sleep 3
    (bin/in apps npm run watch) &
    echo "RAN WATCH"
    wait
  else

    # BUILD

    ARGS=${@:1}
    (bin/in ui npm run build) &
    wait
    (bin/in kit npm run build) &
    (bin/in kit-internal npm run build) &
    wait
    (cd app && npx tsc -b $ARGS) &
    wait
    # todo(umed) once we fix @o/apps we can remove these
    (bin/in apps npm run build) &
    (bin/in orbit-desktop npm run build) &
    (bin/in orbit-syncers npm run build) &
    wait
    echo "RAN BUILD"
  fi
  exit 0
fi

