#!/bin/bash

. $(dirname $0)/__/common
cd $ROOT

# allow errors
set +e

file-exists ".env"
file-exists ".env.dev"

function ensure-dep {
  cmd=${@:1}
  if [ "$(bin-exists $1)" = "" ]; then
    echo "$1 is not installed, installing..."
    if [ "$cmd" = "" ]; then
      echo "please install first!"
      exit 1
    else
      $($cmd)
    fi
  fi
  echo "installed: $1"
}

xcode-select --install 2> /dev/null

ensure-dep "brew" -- /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
ensure-dep "npm" -- brew install node
ensure-dep "docker" -- brew install docker
ensure-dep "docker-machine" -- brew install docker-machine
ensure-dep "xhyve" -- brew cask install xhyve
ensure-dep "kubectl" -- brew install kubectl
ensure-dep "minikube" -- brew cask install minikube
ensure-dep "pip" -- brew install python
ensure-dep "envtpl" -- pip install envtpl

# echo "Make sure to install dotenv and ensure it picks up your .env vars!"
# TODO: revisit once we can use kubes locally nicely
# echo "docker boot"
# docker-machine inspect dev > /dev/null || docker-machine create dev -d xhyve
# dev boot
# echo "minikubes"
# minikube config set WantReportErrorPrompt false
# minikube config set vm-driver xyhve
# minikube addons enable ingress

# /etc/hosts
if grep -q "staging.dev" /etc/hosts; then
  echo "ok" > /dev/null
else
  echo "$(minikube ip) couch.staging.dev api.staging.dev staging.dev" | sudo tee -a /etc/hosts
fi
if grep -q "jot.dev" /etc/hosts; then
  echo "ok" > /dev/null
else
  echo "127.0.0.1 couch.jot.dev api.jot.dev jot.dev" | sudo tee -a /etc/hosts
  echo "12 ::1 jot.dev couch.jot.dev api.jot.dev" | sudo tee -a /etc/hosts
fi

yarn install
echo "lerna bootstrap"
./node_modules/lerna/bin/lerna.js bootstrap

echo "ensuring react isnt duped until pundle fix"
rm -rf packages/ui/node_modules/react
rm -rf packages/decor/node_modules/react
rm -rf packages/black/node_modules/react
rm -rf packages/gloss/node_modules/react

# bugfix for pundle for some reason checking for memdown when it shouldn't
touch apps/web/node_modules/@mcro/models/node_modules/memdown/node_modules/immediate/lib/browser.js

echo " welcome!"
echo " to start the app:"
echo " $ compose up"
echo " $ watch"
echo " $ npm run web"

# echo "   $ minikube up"
# echo "   $ dev start"
# echo "   $ dev serve"
