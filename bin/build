#!/bin/bash

. $(dirname $0)/__/common

cd $ROOT

APP=$1
ARGS=${@:1}

trap killgroup SIGINT
killgroup() {
  kill 0
}

function build-dev() {
  npx lerna exec --parallel \
    --ignore @mcro/web \
      -- \
      babel src --out-dir lib -s true $1
}

function build-prod() {
  npx lerna exec --parallel \
    --ignore @mcro/web \
      -- \
      NODE_ENV=production babel src --out-dir dist -s true $1
}

if [ "$APP" = "electron" ]; then
  cd $ROOT/apps/electron
  npm run dist
elif [ "$APP" = "web" ]; then
  cd $ROOT/apps/web
  rm -rf build
  npm run build
else
  link-flow &

  # only build modern during dev-watch
  if [ "$ARGS" = "--watch" ]; then
    build-dev --watch &
    build-prod --watch &
  else
    build-dev &
    build-prod &
  fi

  wait
  echo "done building"
fi
