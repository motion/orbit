{"version":3,"sources":["../src/index.js"],"names":["Helpers_","Theme","ThemeProvide","Helpers","DEFAULT_OPTS","idCounter","uid","Gloss","constructor","opts","themeSheets","JSS","decorator","optionalNameOrChild","optionalStyle","optionalPropStyles","tagName","styles","id","glossComponent","props","finalProps","key","Object","keys","createElement","glossUID","attachStyles","err","console","log","displayName","Child","error","children","prototype","render","css","glossElement","gloss","glossStylesheet","stylesheet","hasTheme","theme","themeSheet","createStyleSheet","attach","lastProps","glossUpdateTheme","noChange","activeTheme","context","uiThemes","uiActiveThemeName","childTheme","rules","name","style","selector","deleteRule","themeActiveRules","addRules","process","env","NODE_ENV","ogComponentWillMount","componentWillMount","args","call","lastUpdatedStyles","ogrender","window","lastHotReload","Date","now","childKey","force","addRule","stylesKey","getRule","niceStyle","options","helpers","baseStyles"],"mappings":"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","file":"index.js","sourcesContent":["// @flow\nimport fancyElement from './fancyElement'\nimport css from '@mcro/css'\nimport JSS from '~/stylesheet'\nimport * as Helpers_ from '@mcro/css'\nimport isEqual from 'react-fast-compare'\n\n// exports\nimport ThemeProvide_ from './components/themeProvide'\nimport Theme_ from './components/theme'\nexport const Theme = Theme_\nexport const ThemeProvide = ThemeProvide_\nexport const Helpers = Helpers_\n\nexport type Options = {\n  dontTheme?: boolean,\n  baseStyles?: Object,\n  tagName?: boolean,\n  toColor?: Function,\n  isColor?: Function,\n}\n\nconst DEFAULT_OPTS = {}\n\nlet idCounter = 0\nfunction uid() {\n  return idCounter++\n}\n\nexport default class Gloss {\n  options: Options\n  css: (a: Object) => Object\n  baseStyles: ?Object\n  createElement: Function\n  Helpers: Object = Helpers\n  themeSheets = {}\n  // for debug\n  JSS = JSS\n\n  constructor(opts: Options = DEFAULT_OPTS) {\n    this.options = opts\n    this.css = css(opts)\n    this.helpers = this.css.helpers\n    this.stylesheet = JSS.createStyleSheet()\n    this.stylesheet.attach()\n    if (opts.baseStyles) {\n      this.baseStyles = true\n      this.attachStyles(null, opts.baseStyles)\n    }\n    this.createElement = fancyElement(this, this.stylesheet)\n    this.decorator.createElement = this.createElement\n  }\n\n  decorator = (\n    optionalNameOrChild: string | Function,\n    optionalStyle?: Object,\n    optionalPropStyles?: Object,\n  ) => {\n    if (typeof optionalNameOrChild === 'string') {\n      // shorthand -- $('tagName', {}) style component\n      const tagName = optionalNameOrChild\n      const styles = optionalStyle\n      const id = uid()\n      const glossComponent = props => {\n        let finalProps\n        // make propstyles work\n        if (props && optionalPropStyles) {\n          finalProps = {}\n          for (const key of Object.keys(props)) {\n            if (optionalPropStyles[key]) {\n              finalProps[`$${key}`] = props[key]\n            } else {\n              finalProps[key] = props[key]\n            }\n          }\n        } else {\n          finalProps = props\n        }\n        return this.createElement(tagName, { glossUID: id, ...finalProps })\n      }\n      try {\n        this.attachStyles(id, { [tagName]: styles, ...optionalPropStyles })\n      } catch (err) {\n        console.log('error attaching styles:', tagName, this, styles)\n      }\n      glossComponent.displayName = tagName\n      return glossComponent\n    }\n\n    const Child = optionalNameOrChild\n\n    if (!Child) {\n      console.error(\n        'invalid view given to gloss',\n        optionalNameOrChild,\n        optionalStyle,\n        optionalPropStyles,\n      )\n      return () => this.createElement('div', { children: 'Error Component' })\n    }\n\n    // @view decorated style component\n    if (Child.prototype && Child.prototype.render) {\n      const { attachStyles, css } = this\n      Child.prototype.glossElement = this.createElement\n      Child.prototype.gloss = this\n      Child.prototype.glossStylesheet = this.stylesheet\n      const hasTheme = Child.theme && typeof Child.theme === 'function'\n      const themeSheet = JSS.createStyleSheet().attach()\n      const id = uid()\n      // @ts-ignore\n      Child.glossUID = id\n      this.themeSheets[id] = themeSheet\n      if (hasTheme) {\n        let lastProps\n        Child.prototype.glossUpdateTheme = function(props) {\n          const noChange = isEqual(props, lastProps)\n          lastProps = props\n          if (noChange) {\n            return\n          }\n          this.theme = this.theme || themeSheet\n          const activeTheme =\n            this.context.uiThemes &&\n            this.context.uiThemes[this.context.uiActiveThemeName]\n          if (activeTheme) {\n            const childTheme = Child.theme(props, activeTheme, this)\n            const rules = {}\n            for (const name of Object.keys(childTheme)) {\n              const style = css(childTheme[name])\n              const selector = `${name}--${Child.glossUID}--theme`\n              rules[selector] = style\n              this.theme.deleteRule(selector)\n            }\n            this.themeActiveRules = Object.keys(rules)\n            this.theme.addRules(rules)\n          }\n        }\n\n        // for HMR needs to re-run on mount idk why\n        if (process.env.NODE_ENV === 'development') {\n          const ogComponentWillMount = Child.prototype.componentWillMount\n          Child.prototype.componentWillMount = function(...args) {\n            if (hasTheme) {\n              this.glossUpdateTheme(this.props)\n            }\n            if (ogComponentWillMount) {\n              return ogComponentWillMount.call(this, ...args)\n            }\n          }\n        }\n      }\n\n      let lastUpdatedStyles = null\n      const ogrender = Child.prototype.render\n      if (Child.prototype.render) {\n        Child.prototype.render = function(...args) {\n          if (hasTheme) {\n            this.glossUpdateTheme(this.props)\n          }\n          // ONLY IN DEV -- ALWAYS UPDATE STYLESHEET SO HMR STYLE CHANGES WORK\n          if (\n            !lastUpdatedStyles ||\n            (typeof window !== 'undefined' &&\n              window.lastHotReload &&\n              lastUpdatedStyles > window.lastHotReload)\n          ) {\n            attachStyles(Child.glossUID, Child.style, true)\n            lastUpdatedStyles = Date.now()\n          }\n          if (ogrender) {\n            return ogrender.call(this, ...args)\n          }\n        }\n      }\n    }\n  }\n\n  // runs niceStyleSheet on non-function styles\n  attachStyles = (\n    childKey: ?string,\n    styles: ?{ [a: string]: Object },\n    force: boolean = false,\n  ): void => {\n    if (!styles) {\n      return null\n    }\n    for (const key of Object.keys(styles)) {\n      const style = styles[key]\n      // @keyframes\n      if (key[0] === '@') {\n        this.stylesheet.addRule(key, style)\n        continue\n      }\n      const stylesKey = childKey ? `${key}--${childKey}` : key\n      if (typeof style === 'function') {\n        this.stylesheet[stylesKey] = style\n        continue\n      }\n      if (force) {\n        this.stylesheet.deleteRule(stylesKey)\n      }\n      if (!this.stylesheet.getRule(stylesKey)) {\n        const niceStyle = this.css(style)\n        this.stylesheet.addRule(stylesKey, niceStyle)\n      }\n    }\n  }\n}\n"]}