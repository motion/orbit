#!/bin/bash

. $(dirname $0)/__/common

# TODO move this into each package and just have this npm run build in each

# build
if [ "$1" = "" ]; then
  npx lerna exec --parallel -- npm run build
  exit 0
fi

# build --watch
if [ "$1" = "--watch" ]; then
  npx lerna exec --parallel -- npm run watch
  exit 0
fi

# this runs in sub-directories

function build-prod() {
  BABEL_ENV=production babel src --out-dir dist -s true ${@:1}
}
function build-dev() {
  babel src --out-dir lib -s true ${@:1}
}
function build-es6() {
  BABEL_ENV=es6 babel src --out-dir es6 -s true ${@:1}
}

MODES="$1"
FLAGS=""
if [ "$2" = "--watch" ]; then
  FLAGS="--watch --skip-initial-build"
fi

for i in ${MODES//,/$IFS}; do
  if [ "$i" = "prod" ]; then
    build-prod $FLAGS &
  fi
  if [ "$i" = "dev" ]; then
    build-dev $FLAGS &
  fi
  if [ "$i" = "es6" ]; then
    build-es6 $FLAGS &
  fi
done

wait
