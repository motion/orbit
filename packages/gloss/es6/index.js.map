{"version":3,"sources":["../src/index.js"],"names":["Helpers_","Theme","ThemeProvide","Helpers","hash","DEFAULT_OPTS","themeKey","idCounter","uid","Gloss","constructor","opts","themeSheets","JSS","decorator","optionalNameOrChild","optionalStyle","optionalPropStyles","tagName","styles","id","glossComponent","props","finalProps","key","Object","keys","createElement","glossUID","attachStyles","err","console","log","displayName","Child","error","children","prototype","render","css","glossElement","gloss","glossStylesheet","stylesheet","hasTheme","theme","themeSheet","createStyleSheet","attach","ViewCache","glossUpdateTheme","activeTheme","base","context","uiThemes","uiActiveThemeName","childTheme","oldKey","themeActiveRules","deleteRule","rules","name","style","selector","addRules","ogcomponentWillUpdate","componentWillUpdate","args","call","ogcomponentWillUnmount","componentWillUnmount","lastUpdatedStyles","ogrender","window","lastHotReload","Date","now","ogComponentWillMount","componentWillMount","childKey","force","addRule","stylesKey","getRule","niceStyle","options","helpers","baseStyles"],"mappings":"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","file":"index.js","sourcesContent":["// @flow\nimport fancyElement from './fancyElement'\nimport css from '@mcro/css'\nimport JSS from '~/stylesheet'\nimport * as Helpers_ from '@mcro/css'\n\n// exports\nimport ThemeProvide_ from './components/themeProvide'\nimport Theme_ from './components/theme'\nexport const Theme = Theme_\nexport const ThemeProvide = ThemeProvide_\nexport const Helpers = Helpers_\n\n// type exports\n// import { Transform, Color } from '@mcro/css'\n// export type Transform\n// export type Color\nexport type Options = {\n  dontTheme?: boolean,\n  themeKey: string | boolean,\n  baseStyles?: Object,\n  tagName?: boolean,\n  toColor?: Function,\n  isColor?: Function,\n}\n\nconst { hash } = Helpers\n\nconst DEFAULT_OPTS = {\n  themeKey: 'theme',\n}\n\nlet idCounter = 0\nfunction uid() {\n  return idCounter++\n}\n\nexport default class Gloss {\n  options: Options\n  css: (a: Object) => Object\n  baseStyles: ?Object\n  createElement: Function\n  Helpers: Object = Helpers\n  themeSheets = {}\n  // for debug\n  JSS = JSS\n\n  constructor(opts: Options = DEFAULT_OPTS) {\n    this.options = opts\n    this.css = css(opts)\n    this.helpers = this.css.helpers\n    this.stylesheet = JSS.createStyleSheet()\n    this.stylesheet.attach()\n    if (opts.baseStyles) {\n      this.baseStyles = true\n      this.attachStyles(null, opts.baseStyles)\n    }\n    this.createElement = fancyElement(this, this.stylesheet)\n    this.decorator.createElement = this.createElement\n  }\n\n  decorator = (\n    optionalNameOrChild: string | Function,\n    optionalStyle?: Object,\n    optionalPropStyles?: Object,\n  ) => {\n    if (typeof optionalNameOrChild === 'string') {\n      // shorthand -- $('tagName', {}) style component\n      const tagName = optionalNameOrChild\n      const styles = optionalStyle\n      const id = uid()\n      const glossComponent = props => {\n        let finalProps\n        // make propstyles work\n        if (props && optionalPropStyles) {\n          finalProps = {}\n          for (const key of Object.keys(props)) {\n            if (optionalPropStyles[key]) {\n              finalProps[`$${key}`] = props[key]\n            } else {\n              finalProps[key] = props[key]\n            }\n          }\n        } else {\n          finalProps = props\n        }\n        return this.createElement(tagName, { glossUID: id, ...finalProps })\n      }\n      try {\n        this.attachStyles(id, { [tagName]: styles, ...optionalPropStyles })\n      } catch (err) {\n        console.log('error attaching styles:', tagName, this, styles)\n      }\n      glossComponent.displayName = tagName\n      return glossComponent\n    }\n\n    const Child = optionalNameOrChild\n\n    if (!Child) {\n      console.error(\n        'invalid view given to gloss',\n        optionalNameOrChild,\n        optionalStyle,\n        optionalPropStyles,\n      )\n      return () => this.createElement('div', { children: 'Error Component' })\n    }\n\n    // @view decorated style component\n    if (Child.prototype && Child.prototype.render) {\n      const { attachStyles, css } = this\n\n      Child.prototype.glossElement = this.createElement\n      Child.prototype.gloss = this\n      Child.prototype.glossStylesheet = this.stylesheet\n\n      const hasTheme = Child.theme && typeof Child.theme === 'function'\n      const themeSheet = JSS.createStyleSheet().attach()\n      const ViewCache = {}\n      const id = uid()\n      Child.glossUID = id\n      this.themeSheets[id] = themeSheet\n\n      if (hasTheme) {\n        Child.prototype.glossUpdateTheme = function(props) {\n          this.theme = this.theme || themeSheet\n          let activeTheme\n          if (typeof props.theme === 'object') {\n            activeTheme = { base: props.theme }\n          } else {\n            activeTheme =\n              this.context.uiThemes &&\n              this.context.uiThemes[\n                props.theme || this.context.uiActiveThemeName\n              ]\n          }\n          if (activeTheme) {\n            const childTheme = Child.theme(props, activeTheme, this)\n\n            // cache\n            const oldKey = this.themeKey\n            this.themeKey = `${id}${hash(childTheme)}`\n            if (ViewCache[this.themeKey]) {\n              ViewCache[this.themeKey]++\n              return\n            }\n            if (oldKey) {\n              ViewCache[this.themeKey]--\n              if (ViewCache[this.themeKey] === 0) {\n                for (const key of this.themeActiveRules) {\n                  this.theme.deleteRule(key)\n                }\n              }\n            }\n            ViewCache[this.themeKey] = 1\n\n            const rules = {}\n            for (const name of Object.keys(childTheme)) {\n              const style = css(childTheme[name])\n              const selector = `${name}--${this.themeKey}--theme`\n              rules[selector] = style\n              this.theme.deleteRule(selector)\n            }\n            this.themeActiveRules = Object.keys(rules)\n            this.theme.addRules(rules)\n          }\n        }\n\n        // updateTheme on willUpdate\n        const ogcomponentWillUpdate = Child.prototype.componentWillUpdate\n        Child.prototype.componentWillUpdate = function(...args) {\n          this.glossUpdateTheme(args[0])\n          if (ogcomponentWillUpdate) {\n            return ogcomponentWillUpdate.call(this, ...args)\n          }\n        }\n\n        const ogcomponentWillUnmount = Child.prototype.componentWillUnmount\n        Child.prototype.componentWillUnmount = function(...args) {\n          // remove cache\n          ViewCache[this.themeKey]--\n          if (ViewCache[this.themeKey] === 0 && this.themeActiveRules) {\n            for (const key of this.themeActiveRules) {\n              this.theme.deleteRule(key)\n            }\n          }\n          if (ogcomponentWillUnmount) {\n            return ogcomponentWillUnmount.call(this, ...args)\n          }\n        }\n      }\n\n      let lastUpdatedStyles = null\n      const ogrender = Child.prototype.render\n      if (Child.prototype.render) {\n        Child.prototype.render = function(...args) {\n          // ONLY IN DEV -- ALWAYS UPDATE STYLESHEET SO HMR STYLE CHANGES WORK\n          if (\n            !lastUpdatedStyles ||\n            (typeof window !== 'undefined' &&\n              window.lastHotReload &&\n              lastUpdatedStyles > window.lastHotReload)\n          ) {\n            attachStyles(Child.glossUID, Child.style, true)\n            lastUpdatedStyles = Date.now()\n          }\n          if (ogrender) {\n            return ogrender.call(this, ...args)\n          }\n        }\n\n        // on first mount, attach styles\n        const ogComponentWillMount = Child.prototype.componentWillMount\n        Child.prototype.componentWillMount = function(...args) {\n          if (hasTheme) {\n            this.glossUpdateTheme(this.props)\n          }\n          if (ogComponentWillMount) {\n            return ogComponentWillMount.call(this, ...args)\n          }\n        }\n      }\n    }\n  }\n\n  // runs niceStyleSheet on non-function styles\n  attachStyles = (\n    childKey: ?string,\n    styles: ?{ [a: string]: Object },\n    force: boolean = false,\n  ): void => {\n    if (!styles) {\n      return null\n    }\n    for (const key of Object.keys(styles)) {\n      const style = styles[key]\n      // @keyframes\n      if (key[0] === '@') {\n        console.log('adding animation')\n        this.stylesheet.addRule(key, style)\n        continue\n      }\n      const stylesKey = childKey ? `${key}--${childKey}` : key\n      if (typeof style === 'function') {\n        this.stylesheet[stylesKey] = style\n        continue\n      }\n      if (force) {\n        this.stylesheet.deleteRule(stylesKey)\n      }\n      if (!this.stylesheet.getRule(stylesKey)) {\n        const niceStyle = this.css(style)\n        this.stylesheet.addRule(stylesKey, niceStyle)\n      }\n    }\n  }\n}\n"]}