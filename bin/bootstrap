#!/bin/bash

. $(dirname $0)/__/common
cd $ROOT

# dont allow errors
set -e

file-exists ".env"
source .env

xcode-select --install 2> /dev/null || true
# this on in sync before running brew checks
ensure-dep "brew" -- /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
ensure-dep "npm" -- brew install node &
ensure-dep "realpath" -- brew install coreutils &
ensure-dep "yarn" -- npm i -g yarn &
ensure-dep "python3" -- brew install python3 &
# ensure-dep "carthage" -- brew install carthage &
wait
ensure-dep "tsc" -- npm i -g typescript
# ensure-dep "pyenv" -- ./apps/oracle/build.sh
echo "installing root"
yarn install
echo "installing packages"
npx lerna bootstrap --loglevel=warn
# internal tools
if [ ! -f "./packages/gloss/_/gloss.js" ]; then
  build-builder-modules
fi
# link second
if [ ! -L "./node_modules/@mcro/gloss" ]; then
  link-root-modules
fi
# build everything
if [ ! -d "./packages/ui/_" ]; then
  build-all
fi

printf "\n\n"
printf "  ğŸ‰ğŸ‰ğŸ‰ bootstrapped! ğŸ‰ğŸ‰ğŸ‰"
printf "\n\n"
printf "1) be sure you are running:"
printf "\n\n"
printf "    build --watch"
printf "\n\n"
printf "2) run your apps in any order, in separate consoles:"
printf "\n\n"
printf "    run app\n"
printf "    run desktop\n"
printf "    run electron\n"
printf "\n\n"
