{"version":3,"sources":["../src/index.js"],"names":["proxyReactComponents","viewProxies","reloaded","reloadedInstances","lastHotReload","Date","now","module","hot","accept","data","dispose","filename","components","imports","locals","React","Error","doHotReload","instance","hotReload","wrapWithProxy","ReactClass","uid","isInFunction","displayName","path","push","instances","update","setTimeout","forEach","console","log","window","start","get","setInterval","length","join"],"mappings":";;;;;kBAiBwBA,oB;;AAjBxB;;;;AACA;;;;;;AAEA,IAAIC,cAAc,EAAlB;AACA,IAAIC,WAAW,EAAf;AACA,IAAIC,oBAAoB,CAAxB;AACA,IAAIC,gBAAgBC,KAAKC,GAAL,EAApB;;AAEA,IAAIC,UAAUA,OAAOC,GAAjB,IAAwBD,OAAOC,GAAP,CAAWC,MAAvC,EAA+C;AAC7CF,SAAOC,GAAP,CAAWC,MAAX,CAAkB,MAAM;AACtBR,kBAAcM,OAAOC,GAAP,CAAWE,IAAX,CAAgBT,WAAhB,IAA+B,EAA7C;AACD,GAFD;AAGAM,SAAOC,GAAP,CAAWG,OAAX,CAAmBD,QAAQ;AACzBA,SAAKT,WAAL,GAAmBA,WAAnB;AACD,GAFD;AAGD;;AAEc,SAASD,oBAAT,CAA8B;AAC3CY,UAD2C;AAE3CC,YAF2C;AAG3CC,SAH2C;AAI3CC;AAJ2C,CAA9B,EAKZ;AACD,QAAM,CAACC,KAAD,IAAUF,OAAhB;AACA,QAAM,CAACP,MAAD,IAAWQ,MAAjB;AACA,QAAM,CAAC,EAAEP,GAAF,EAAD,IAAYO,MAAlB;;AAEA,MAAI,CAACP,GAAD,IAAQ,OAAOA,IAAIC,MAAX,KAAsB,UAAlC,EAA8C;AAC5C,UAAM,IAAIQ,KAAJ,CACJ,8HADI,CAAN;AAGD;;AAED,QAAMC,cAAcC,YAAY;AAC9B,QAAIA,SAASC,SAAb,EAAwB;AACtBD,eAASC,SAAT,CAAmBb,MAAnB;AACD;AACD,wCAAgBY,QAAhB;AACAhB;AACD,GAND;;AAQA,SAAO,SAASkB,aAAT,CAAuBC,UAAvB,EAAmCC,GAAnC,EAAwC;AAC7C,UAAM,EAAEC,YAAF,EAAgBC,cAAcF,GAA9B,KAAsCV,WAAWU,GAAX,CAA5C;AACA,UAAMG,OAAOd,WAAW,GAAX,GAAiBW,GAA9B;;AAEA,QAAIC,YAAJ,EAAkB;AAChB,aAAOF,UAAP;AACD;;AAED,QAAIf,UAAUA,OAAOC,GAAjB,IAAwBD,OAAOC,GAAP,CAAWC,MAAvC,EAA+C;AAC7CF,aAAOC,GAAP,CAAWC,MAAX,CAAkB,MAAM,CAAE,CAA1B,EAD6C,CACjB;AAC7B;;AAED;AACA,QAAIR,YAAYyB,IAAZ,CAAJ,EAAuB;AACrBxB,eAASyB,IAAT,CAAcF,WAAd;AACA,YAAMG,YAAY3B,YAAYyB,IAAZ,EAAkBG,MAAlB,CAAyBP,UAAzB,CAAlB;AACAQ,iBAAW,MAAM;AACfF,kBAAUG,OAAV,CAAkBb,WAAlB;;AAEA;AACAc,gBAAQC,GAAR,CAAY,iBAAZ,EAA+B5B,KAAKC,GAAL,KAAaF,aAA5C;AACA,YAAIC,KAAKC,GAAL,KAAaF,aAAb,GAA6B,IAA7B,IAAqC8B,OAAOC,KAAhD,EAAuD;AACrDD,iBAAOC,KAAP;AACA/B,0BAAgBC,KAAKC,GAAL,EAAhB;AACD;;AAED;AACD,OAXD;AAYD,KAfD,MAeO;AACLL,kBAAYyB,IAAZ,IAAoB,0BAAYJ,UAAZ,CAApB;AACD;;AAED,WAAOrB,YAAYyB,IAAZ,EAAkBU,GAAlB,EAAP;AACD,GAjCD;AAkCD;;AAEDC,YAAY,MAAM;AAChB,MAAInC,SAASoC,MAAb,EAAqB;AACnBN,YAAQC,GAAR,CACG,gBAAe/B,SAASqC,IAAT,CAAc,IAAd,CAAoB,KAAIpC,iBAAkB,YAD5D;AAGAD,eAAW,EAAX;AACAC,wBAAoB,CAApB;AACD;AACF,CARD,EAQG,IARH","file":"index.js","sourcesContent":["import createProxy from './proxyClass'\nimport deepForceUpdate from 'react-deep-force-update'\n\nlet viewProxies = {}\nlet reloaded = []\nlet reloadedInstances = 0\nlet lastHotReload = Date.now()\n\nif (module && module.hot && module.hot.accept) {\n  module.hot.accept(() => {\n    viewProxies = module.hot.data.viewProxies || {}\n  })\n  module.hot.dispose(data => {\n    data.viewProxies = viewProxies\n  })\n}\n\nexport default function proxyReactComponents({\n  filename,\n  components,\n  imports,\n  locals,\n}) {\n  const [React] = imports\n  const [module] = locals\n  const [{ hot }] = locals\n\n  if (!hot || typeof hot.accept !== 'function') {\n    throw new Error(\n      'locals[0] does not appear to be a `module` object with Hot Module replacement API enabled. You should disable @mcro/view-hmr'\n    )\n  }\n\n  const doHotReload = instance => {\n    if (instance.hotReload) {\n      instance.hotReload(module)\n    }\n    deepForceUpdate(instance)\n    reloadedInstances++\n  }\n\n  return function wrapWithProxy(ReactClass, uid) {\n    const { isInFunction, displayName = uid } = components[uid]\n    const path = filename + '$' + uid\n\n    if (isInFunction) {\n      return ReactClass\n    }\n\n    if (module && module.hot && module.hot.accept) {\n      module.hot.accept(() => {}) // to make it a fast hmr\n    }\n\n    // if existing proxy\n    if (viewProxies[path]) {\n      reloaded.push(displayName)\n      const instances = viewProxies[path].update(ReactClass)\n      setTimeout(() => {\n        instances.forEach(doHotReload)\n\n        // double save helper to force clear better on two saves\n        console.log('Since last hmr:', Date.now() - lastHotReload)\n        if (Date.now() - lastHotReload < 1500 && window.start) {\n          window.start()\n          lastHotReload = Date.now()\n        }\n\n        // Black.view.emit('hmr')\n      })\n    } else {\n      viewProxies[path] = createProxy(ReactClass)\n    }\n\n    return viewProxies[path].get()\n  }\n}\n\nsetInterval(() => {\n  if (reloaded.length) {\n    console.log(\n      `[HMR] views: ${reloaded.join(', ')}, ${reloadedInstances} instances`\n    )\n    reloaded = []\n    reloadedInstances = 0\n  }\n}, 1000)\n"]}