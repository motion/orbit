#!/bin/bash

# set env then source
export ENV="dev"

. $(dirname $0)/__common
cd $ROOT

# set dev context
export KUBECONFIG=infra/keys/kubes/dev
kubectl config use-context minikube > /dev/null

ACTION=$1

function cleanup-docker() {
  docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc:/etc spotify/docker-gc
}

function ensure-minikube {
  minikube ip > /dev/null || minikube start --memory=2048 --vm-driver=xhyve
}

# PRE RUN

# ensure minikube started
ensure-minikube

# ensure sourced docker-env
if [ "$DOCKER_TLS_VERIFY" != "1" ]; then
  if minikube docker-env > /dev/null 2>&1; then
    eval $(minikube docker-env)
  else
    echo "no minikube docker-env"
  fi
fi

# RUN
if [ "$ACTION" = "boot" ]; then
  echo "booted"
elif [ "$ACTION" = "ui" ]; then
  minikube dashboard
elif [ "$ACTION" = "open" ]; then
  open $(minikube service pad-web --url)
elif [ "$ACTION" = "cleanup-docker" ]; then
  cleanup-docker
elif [ "$ACTION" = "run" ]; then
  # allow abritrary things to run
  ${@:1}
else
  bin/__kubes ${@:1}
fi

# POST RUN
if [ "$ACTION" = "stop" ]; then
  minikube stop
fi
