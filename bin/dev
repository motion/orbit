#!/bin/bash

#
# see __kubes for actions
#

# set env then source
export ENV="dev"
. $(dirname $0)/__common
cd $ROOT

MINIKUBE_MEMORY=4086

# set dev context
export KUBECONFIG=infra/keys/kubes/dev
kubectl config use-context minikube > /dev/null

ACTION=$1


function cleanup-docker() {
  docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v /etc:/etc spotify/docker-gc
}

function start-minikube {
  echo "$ minikube start --memory=$MINIKUBE_MEMORY"
  minikube start --memory=$MINIKUBE_MEMORY
}

function ensure-minikube {
  minikube ip > /dev/null || start-minikube
}

# PRE RUN

# ensure minikube started
ensure-minikube

# ensure sourced docker-env
if [ "$DOCKER_TLS_VERIFY" != "1" ]; then
  if minikube docker-env > /dev/null 2>&1; then
    eval $(minikube docker-env)
  else
    echo "no minikube docker-env"
  fi
fi

# RUN
# async
if [ "$ACTION" = "status" ]; then
  minikube status
fi

# synchronous
if [ "$ACTION" = "boot" ]; then
  echo "ok"
elif [ "$ACTION" = "ui" ]; then
  minikube dashboard
elif [ "$ACTION" = "open" ]; then
  open $(minikube service pad-web --url)
elif [ "$ACTION" = "cleanup-docker" ]; then
  cleanup-docker
else
  bin/__kubes ${@:1}
fi

# POST RUN
if [ "$ACTION" = "stop" ]; then
  minikube stop
fi
