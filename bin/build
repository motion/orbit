#!/bin/bash

. $(dirname $0)/__/common

cd $ROOT

APP=$1
ARGS=${@:1}

trap killgroup SIGINT
killgroup() {
  kill 0
}

function build-es6() {
  npx lerna exec --parallel \
    --ignore @mcro/native  \
    --ignore @mcro/web \
    --ignore @mcro/couch \
    --ignore @mcro/playground \
      -- \
      babel src --out-dir lib -s true $1
}

function build-es5() {
  npx lerna exec --parallel \
    --ignore @mcro/native  \
    --ignore @mcro/web \
    --ignore @mcro/couch \
    --ignore @mcro/playground \
      -- \
      NODE_ENV=es5 babel src --out-dir dist -s true $1
}

if [ "$APP" = "electron" ]; then
  cd $ROOT/apps/electron
  npm run dist
elif [ "$APP" = "web" ]; then
  build-es5
  cd $ROOT/apps/web
  rm -rf build
  npm run build
else
  link-flow &

  # only build modern during dev-watch
  if [ "$ARGS" = "--watch" ]; then
    build-es6 --watch &
  else
    build-es6 &
    build-es5 &
  fi

  wait
  echo "done building"
fi
