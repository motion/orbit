{"version":3,"sources":["../src/index.js"],"names":["proxyReactComponents","viewProxies","reloaded","reloadedInstances","module","hot","accept","data","dispose","filename","components","imports","locals","React","Error","forceUpdater","hotReload","instance","push","wrapWithProxy","ReactClass","uid","isInFunction","displayName","path","console","log","instances","update","setTimeout","forEach","get","setInterval","length","join"],"mappings":";;;;;;;;kBAewBA,oB;;AAfxB;;;;AACA;;;;AACA;;;;AAEA,IAAIC,cAAc,EAAlB;AACA,IAAIC,WAAW,EAAf;AACA,IAAIC,oBAAoB,EAAxB;;AAEAC,OAAOC,GAAP,CAAWC,MAAX,CAAkB,YAAM;AACtBL,gBAAcG,OAAOC,GAAP,CAAWE,IAAX,CAAgBN,WAAhB,IAA+B,EAA7C;AACD,CAFD;AAGAG,OAAOC,GAAP,CAAWG,OAAX,CAAmB,gBAAQ;AACzBD,OAAKN,WAAL,GAAmBA,WAAnB;AACD,CAFD;;AAIe,SAASD,oBAAT,OAKZ;AAAA,MAJDS,QAIC,QAJDA,QAIC;AAAA,MAHDC,UAGC,QAHDA,UAGC;AAAA,MAFDC,OAEC,QAFDA,OAEC;AAAA,MADDC,MACC,QADDA,MACC;;AAAA,gCACeD,OADf;AAAA,MACME,KADN;;AAAA,+BAEgBD,MAFhB;AAAA,MAEMR,MAFN;;AAAA,gCAGiBQ,MAHjB;AAAA,MAGQP,GAHR,eAGQA,GAHR;;AAKD,MAAI,CAACA,GAAD,IAAQ,OAAOA,IAAIC,MAAX,KAAsB,UAAlC,EAA8C;AAC5C,UAAM,IAAIQ,KAAJ,CACJ,8HADI,CAAN;AAGD;;AAED,MAAMC,eAAe,gCAAeF,SAAS,iBAAOA,KAA/B,CAArB;;AAEA,MAAMG,YAAY,SAAZA,SAAY,WAAY;AAC5BD,iBAAaE,QAAb;AACAd,sBAAkBe,IAAlB,CAAuB,CAAvB;AACD,GAHD;;AAKA,SAAO,SAASC,aAAT,CAAuBC,UAAvB,EAAmCC,GAAnC,EAAwC;AAAA,0BACDX,WAAWW,GAAX,CADC;AAAA,QACrCC,YADqC,mBACrCA,YADqC;AAAA,gDACvBC,WADuB;AAAA,QACvBA,WADuB,yCACTF,GADS;;AAE7C,QAAMG,OAAOf,WAAW,GAAX,GAAiBY,GAA9B;;AAEA,QAAIC,YAAJ,EAAkB;AAChB,aAAOF,UAAP;AACD;;AAEDhB,WAAOC,GAAP,CAAWC,MAAX,CAAkB,YAAM;AACtBmB,cAAQC,GAAR,CAAY,UAAZ,EAAwBF,IAAxB;AACD,KAFD,EAR6C,CAU1C;;AAEH;AACA,QAAIvB,YAAYuB,IAAZ,CAAJ,EAAuB;AACrBtB,eAASgB,IAAT,CAAcK,WAAd;AACA,UAAMI,YAAY1B,YAAYuB,IAAZ,EAAkBI,MAAlB,CAAyBR,UAAzB,CAAlB;AACAS,iBAAW;AAAA,eAAMF,UAAUG,OAAV,CAAkBd,SAAlB,CAAN;AAAA,OAAX;AACD,KAJD,MAIO;AACLf,kBAAYuB,IAAZ,IAAoB,0BAAYJ,UAAZ,CAApB;AACD;;AAED,WAAOnB,YAAYuB,IAAZ,EAAkBO,GAAlB,EAAP;AACD,GAtBD;AAuBD;;AAEDC,YAAY,YAAM;AAChB,MAAI9B,SAAS+B,MAAb,EAAqB;AACnBR,YAAQC,GAAR,CACG,gBAAexB,SAASgC,IAAT,CACd,IADc,CAEd,KAAI/B,kBAAkB8B,MAAO,YAHjC;AAKA/B,eAAW,EAAX;AACAC,wBAAoB,EAApB;AACD;AACF,CAVD,EAUG,IAVH","file":"index.js","sourcesContent":["import window from 'global/window'\nimport createProxy from './proxyClass'\nimport { getForceUpdate } from 'react-proxy'\n\nlet viewProxies = {}\nlet reloaded = []\nlet reloadedInstances = []\n\nmodule.hot.accept(() => {\n  viewProxies = module.hot.data.viewProxies || {}\n})\nmodule.hot.dispose(data => {\n  data.viewProxies = viewProxies\n})\n\nexport default function proxyReactComponents({\n  filename,\n  components,\n  imports,\n  locals,\n}) {\n  const [React] = imports\n  const [module] = locals\n  const [{ hot }] = locals\n\n  if (!hot || typeof hot.accept !== 'function') {\n    throw new Error(\n      'locals[0] does not appear to be a `module` object with Hot Module replacement API enabled. You should disable @mcro/view-hmr'\n    )\n  }\n\n  const forceUpdater = getForceUpdate(React || window.React)\n\n  const hotReload = instance => {\n    forceUpdater(instance)\n    reloadedInstances.push(1)\n  }\n\n  return function wrapWithProxy(ReactClass, uid) {\n    const { isInFunction, displayName = uid } = components[uid]\n    const path = filename + '$' + uid\n\n    if (isInFunction) {\n      return ReactClass\n    }\n\n    module.hot.accept(() => {\n      console.log('accepted', path)\n    }) // to make it a fast hmr\n\n    // if existing proxy\n    if (viewProxies[path]) {\n      reloaded.push(displayName)\n      const instances = viewProxies[path].update(ReactClass)\n      setTimeout(() => instances.forEach(hotReload))\n    } else {\n      viewProxies[path] = createProxy(ReactClass)\n    }\n\n    return viewProxies[path].get()\n  }\n}\n\nsetInterval(() => {\n  if (reloaded.length) {\n    console.log(\n      `[HMR] views: ${reloaded.join(\n        ', '\n      )}, ${reloadedInstances.length} instances`\n    )\n    reloaded = []\n    reloadedInstances = []\n  }\n}, 1000)\n"]}