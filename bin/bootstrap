#!/bin/bash

function link-root-modules() {
  npx lerna exec -- yarn link
  yarn link @mcro/gloss &
  yarn link @mcro/css &
  yarn link @mcro/babel-plugin-if &
  yarn link @mcro/babel-preset-motion &
  wait
}

function build-builder-modules() {
  (cd packages/gloss && npm run build) &
  (cd packages/css && npm run build) &
  (cd packages/gloss-displaynames && npm run build) &
  wait
}

. $(dirname $0)/__/common
cd $ROOT

# dont allow errors
set -e

file-exists ".env"
source .env

xcode-select --install 2> /dev/null || true
# this on in sync before running brew checks
ensure-dep "brew" -- /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
ensure-dep "npm" -- brew install node &
ensure-dep "realpath" -- brew install coreutils &
ensure-dep "yarn" -- npm i -g yarn &
ensure-dep "python3" -- brew install python3 &
# ensure-dep "carthage" -- brew install carthage &
wait
ensure-dep "tsc" -- npm i -g typescript
# ensure-dep "pyenv" -- ./apps/oracle/build.sh
echo "installing root"
yarn install
echo "installing packages"
npx lerna bootstrap --loglevel=warn
# internal tools
ensure-file ./packages/gloss/_/gloss.js -- build-builder-modules
ensure-file ./packages/css/_/css.js -- build-builder-modules
ensure-file ./packages/gloss-displaynames/_/index.js -- build-builder-modules
# link second
ensure-symlink ./node_modules/@mcro/gloss -- link-root-modules
# build everything once
ensure-dir ./packages/ui/_ -- build
echo "bootstrapped!"
echo "run desktop; run app; run electron"
