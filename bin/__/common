#!/bin/bash

# break on errors
set -e

APP_OLD_PWD="$(pwd)"
OLD_PATH=$PATH

cd $(dirname $0)/..

# source env
source .env

# set path/root
PATH=/usr/local/bin:/usr/bin
ROOT="$(pwd)"

# add node_modules
PATH=$OLD_PATH:$ROOT/node_modules/.bin

# cd back to original dir
cd $APP_OLD_PWD

# run with echo
function run {
  echo "$" "$@"
  eval $(printf '%q ' "$@") < /dev/tty
}

function parse-config {
  envtpl $1 -o ./app_data/tmpconf --keep-template
  cat ./app_data/tmpconf
}

# get kubes config
function save-config {
  rm -rf $KUBES_CONFIG_OUT
  mkdir -p $KUBES_CONFIG_OUT

  ALL=""

  for path in ./infra/kubes/*; do
    OUT="$KUBES_CONFIG_OUT/$(basename $path .yml).yml"
    parse-config $path > $OUT
    ALL+=$(parse-config $path)
    ALL+=$'\n'
  done

  # add in extra env configs
  dir=./infra/kubes.$ENV
  if [ -d $dir ]; then
    for path in $dir/*; do
      OUT="$KUBES_CONFIG_OUT/$(basename $path .yml).yml"
      parse-config $path > $OUT
      ALL+=$(parse-config $path)
      ALL+=$'\n'
    done
  fi

  echo "$ALL" > "$KUBES_CONFIG_FILE"
}

function bin-exists {
  echo "$(which $1 2> /dev/null)"
}

function file-exists {
  if [ ! -f "$1" ]; then
    echo "$2 not found"
    exit 1
  fi
}

function ensure-dep {
  cmd=${@:3}
  if [ "$(bin-exists $1)" = "" ]; then
    echo "$1 is not installed, installing..."
    if [ "$cmd" = "" ]; then
      echo "please install first!"
      exit 1
    else
      $($cmd)
    fi
  fi
}

function ensure-dir {
  cmd=${@:3}
  if [ ! -d "$1" ]; then
    echo "$1 doesnt exist, running... $cmd"
    $($cmd)
  fi
}

function ensure-file {
  cmd=${@:3}
  if [ ! -f "$1" ]; then
    echo "$1 doesnt exist, running... $cmd"
    $($cmd)
  fi
}

function ensure-symlink {
  cmd=${@:3}
  if [ ! -L "$1" ]; then
    echo "$1 doesnt exist, running... $cmd"
    $($cmd)
  fi
}

