#!/bin/bash

. $(dirname $0)/__/common

cd $ROOT

APP=$1
ARGS=${@:1}

trap killgroup SIGINT
killgroup() {
  kill 0
}

function build-dev() {
  npx lerna exec --parallel \
    --ignore @mcro/web \
    --ignore @mcro/site \
      -- \
      babel src --out-dir lib -s true $1
}

function build-es5() {
  npx lerna exec --parallel \
    --ignore @mcro/web \
    --ignore @mcro/site \
      -- \
        BABEL_ENV=es5 babel src --out-dir es5 -s true $1
}

function build-prod() {
  npx lerna exec --parallel \
    --ignore @mcro/web \
    --ignore @mcro/site \
      -- \
        BABEL_ENV=dist babel src --out-dir dist -s true $1
}

function build-api() {
  cd apps/api
  BABEL_ENV=es5 babel src --out-dir es5 -s true $1
}

if [ "$APP" = "electron" ]; then
  cd $ROOT/apps/electron
  npm run dist
elif [ "$APP" = "site" ]; then
  cd $ROOT/apps/site
  npm run build
elif [ "$APP" = "api" ]; then
  build-api
elif [ "$APP" = "web" ]; then
  cd $ROOT/apps/web
  rm -rf build
  npm run build
  ls -lah apps/web/build/js
else
  # only build modern during dev-watch
  if [ "$ARGS" = "--watch" ]; then
    build-dev --watch &
    build-prod --watch &
    build-api --watch &
  else
    build-dev &
    build-prod &
    build-api &
  fi

  wait
  echo "done building"
fi
